## Generated by Chef ##
user                            www-data;
worker_processes                1;

error_log                       /var/log/nginx/error.log;
pid                             /var/run/nginx.pid;

events {
    worker_connections          1024;
}

http {
    include                     /etc/nginx/mime.types;
    default_type                application/octet-stream;
    access_log                  /var/log/nginx/access.log;

    sendfile                    on;
    keepalive_timeout           65;
    tcp_nodelay                 on;
    gzip                        on;

	ssl_certificate				  <%= "#{node[:nginx][:ssl_certificate]}" %>;
	ssl_certificate_key			  <%= "#{node[:nginx][:ssl_certificate_key]}" %>;

	
	 <% @host.each do |a,b| -%>
		 upstream <%= "#{a}" %> {
	 <% b["servers"].each do |c| -%>
			server <%=  "#{c}" %>;
	<% end -%>				
		}
		server {
			<% b["listen_port"].each do |port| -%>
			listen <%= "#{port}"%>;
			<% end-%>
			ssl		<%= b["ssl"] -%>;	
			server_name	<% b["server_name"].each do |name| -%><%= "#{name} "%><% end -%>;
			<% if b["location"].nil? -%>
			location / {
				proxy_pass http://<%= a %>;
			}
				<%else b["location"].each do |loc,data| -%>
			location <%= "#{loc}"%> {
				<% data.each do |d| -%>
				<%= "#{d}"%>;
				<% end -%>
			}			
				<% end -%>
			<% end -%>
			<% if b["log_format"].nil? -%>
			error_log   /var/log/nginx/<%=b["log"]%>/error.log;
 		        access_log  /var/log/nginx/<%=b["log"]%>/access.log;
				<% else-%>
			 log_format <%= b["log_format"]%>    '$remote_addr - $remote_user [$time_local]  '
                                             '"$request" $status $bytes_sent $request_time '
                                             '"$http_referer" "$http_user_agent"';
			error_log   /var/log/nginx/<%=b["log"]%>/error.log;
			access_log  /var/log/nginx/<%=b["log"]%>/access.log <%= b["log_format"]%>;
			<% end -%>
		}

	<% end -%>	

}
